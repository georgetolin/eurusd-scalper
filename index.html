<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Forex Trading Assistant | Live Alpha Vantage Data</title>
  <meta name="description" content="AI-powered Forex scalping assistant with real Alpha Vantage data and technical indicators">
  
  <style>
    /* ... (all previous CSS remains the same) ... */
    
    /* Fix for tabs */
    .tabs-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
      overflow-x: auto;
    }
    
    .tabs::-webkit-scrollbar {
      height: 4px;
    }
    
    .tabs::-webkit-scrollbar-track {
      background: var(--border-light);
    }
    
    .tabs::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 8px;
      transition: var(--transition);
      white-space: nowrap;
    }
    
    .tab-btn.active {
      background: var(--av-blue);
      color: white;
    }
    
    .tab-btn:hover:not(.active) {
      background: var(--border-light);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Ensure all tab contents are properly structured */
    .tab-pane {
      display: none;
    }
    
    .tab-pane.active {
      display: block;
    }
    
    /* Responsive fixes */
    @media (max-width: 768px) {
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>

  <!-- TradingView Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body data-theme="dark">
  <div class="app">
    <!-- Left Column: Main Content -->
    <div class="main-container">
      <!-- Main Tabs -->
      <div class="tabs-container">
        <div class="tabs" id="mainTabs">
          <button class="tab-btn active" data-tab="calculator">Position Calculator</button>
          <button class="tab-btn" data-tab="ai-assistant">AI Trading Assistant</button>
          <button class="tab-btn" data-tab="market-data">Market Data</button>
        </div>
      </div>

      <!-- Calculator Tab -->
      <div class="tab-content active" id="calculator-content">
        <div class="calculator-container">
          <!-- Calculator content remains the same -->
          <div class="header">
            <div class="top-bar">
              <div>
                <h1>Forex & Gold Scalping Calculator <span class="api-badge">Alpha Vantage</span></h1>
                <p class="subtitle">Professional position sizing calculator with real-time Alpha Vantage data for major forex pairs and XAU/USD.</p>
              </div>
              <button class="theme-toggle" id="themeBtn">
                <span class="theme-icon">üåô</span>
                <span class="theme-text">Dark Mode</span>
              </button>
            </div>

            <div class="currency-badges">
              <div class="currency-badge active" data-currency="EURUSD">EUR/USD</div>
              <div class="currency-badge" data-currency="GBPUSD">GBP/USD</div>
              <div class="currency-badge" data-currency="USDJPY">USD/JPY</div>
              <div class="currency-badge" data-currency="AUDUSD">AUD/USD</div>
              <div class="currency-badge" data-currency="USDCAD">USD/CAD</div>
              <div class="currency-badge" data-currency="USDCHF">USD/CHF</div>
              <div class="currency-badge xau" data-currency="XAUUSD">XAU/USD</div>
            </div>
          </div>

          <div class="currency-selector">
            <label>Selected Instrument:</label>
            <div class="selected-currency" id="selectedCurrency">
              <span class="symbol">EUR/USD</span>
              <span class="name">Euro vs US Dollar</span>
            </div>
          </div>

          <div class="grid">
            <div class="input-group">
              <label for="entry" class="required">Entry Price</label>
              <input 
                type="number" 
                id="entry" 
                step="0.00001" 
                placeholder="e.g., 1.07450"
                min="0.5"
                max="2"
              >
              <div class="input-hint">Current market price for selected instrument</div>
            </div>
            
            <div class="input-group">
              <label for="stop" class="required">Stop Loss Price</label>
              <input 
                type="number" 
                id="stop" 
                step="0.00001" 
                placeholder="e.g., 1.07350"
              >
              <div class="input-hint">Price where you'll exit to limit losses</div>
            </div>
            
            <div class="input-group">
              <label for="take" class="required">Take Profit Price</label>
              <input 
                type="number" 
                id="take" 
                step="0.00001" 
                placeholder="e.g., 1.07600"
              >
              <div class="input-hint">Price where you'll take profits</div>
            </div>
            
            <div class="input-group">
              <label for="balance" class="required">Account Balance (USD)</label>
              <input 
                type="number" 
                id="balance" 
                step="0.01" 
                placeholder="e.g., 10000"
                min="100"
              >
              <div class="input-hint">Your trading account balance in USD</div>
            </div>
            
            <div class="input-group">
              <label for="riskPct" class="required">Risk Per Trade (%)</label>
              <input 
                type="number" 
                id="riskPct" 
                step="0.01" 
                placeholder="e.g., 0.5"
                min="0.01"
                max="5"
                value="0.5"
              >
              <div class="input-hint">Recommended: 0.5% - 2% of account balance</div>
            </div>
            
            <div class="input-group">
              <label for="pipValue">Position Size Type</label>
              <select id="pipValue">
                <option value="10">Standard (1.0 lot = $10/pip)</option>
                <option value="1">Mini (0.1 lot = $1/pip)</option>
                <option value="0.1">Micro (0.01 lot = $0.10/pip)</option>
              </select>
              <div class="input-hint">Select based on your broker account type</div>
            </div>
          </div>

          <div class="currency-info" id="currencyInfo">
            <div><span class="pip">1 pip = 0.0001</span> (4th decimal)</div>
            <div>Typical spread: <span class="spread">0.6-1.2 pips</span></div>
            <div>Trading hours: London-NY overlap (13:00-16:00 GMT)</div>
          </div>

          <div class="actions">
            <button class="btn-primary" id="calcBtn">
              <span>üìä Calculate Position Size</span>
            </button>
            <button class="btn-secondary" id="resetBtn">
              <span>üîÑ Reset All</span>
            </button>
            <button class="btn-chart" id="syncChartBtn">
              <span>üìà Sync with Chart</span>
            </button>
            <button class="btn-chart" id="syncMarketDataBtn" style="background: var(--av-blue);">
              <span>üìä Use Market Data</span>
            </button>
          </div>

          <div class="result" id="result">
            <h2 style="margin-bottom: 20px; color: var(--text);">Results for <span id="resultCurrency">EUR/USD</span></h2>
            <div class="result-grid">
              <div class="result-item">
                <h3>Pips to Stop Loss</h3>
                <div class="result-value" id="pipsStop">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Pips to Take Profit</h3>
                <div class="result-value" id="pipsTake">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Risk : Reward Ratio</h3>
                <div class="result-value" id="rr">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Risk Amount (USD)</h3>
                <div class="result-value" id="riskUsd">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Position Size (Lots)</h3>
                <div class="result-value" id="lots">‚Äî</div>
              </div>
              <div class="result-item">
                <h3>Position Units</h3>
                <div class="result-value" id="units">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="status" id="status"></div>

          <div class="footer">
            <div class="tip">
              <p><strong>üí° Trading Information:</strong></p>
              <p><strong>EUR/USD:</strong> Most liquid pair, best during London/NY overlap (13:00-16:00 GMT)<br>
              <strong>GBP/USD:</strong> High volatility, watch for UK economic news (08:00 GMT)<br>
              <strong>USD/JPY:</strong> Lower spreads, influenced by BOJ and US yields (Tokyo session)<br>
              <strong>XAU/USD:</strong> 1 pip = $0.01, trades 24/5, higher spreads (0.3-0.8), high volatility</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              Powered by Alpha Vantage API | Real-time forex data and technical indicators<br>
              Disclaimer: This tool is for educational purposes. Trading involves risk of loss.
            </p>
          </div>
        </div>
      </div>

      <!-- AI Assistant Tab -->
      <div class="tab-content" id="ai-assistant-content">
        <div class="ai-assistant-container">
          <div class="ai-header">
            <div class="ai-title">
              <span class="ai-icon">ü§ñ</span>
              AI Trading Assistant
            </div>
            <button class="theme-toggle" id="aiThemeBtn">
              <span class="theme-icon">üåô</span>
              <span class="theme-text">Dark Mode</span>
            </button>
          </div>

          <!-- AI Assistant Tabs -->
          <div class="tabs-container">
            <div class="tabs" id="aiTabs">
              <button class="tab-btn active" data-ai-tab="analysis">Signal Analysis</button>
              <button class="tab-btn" data-ai-tab="settings">AI Settings</button>
            </div>
          </div>

          <!-- AI Analysis Content -->
          <div class="ai-tab-content active" id="analysis-content">
            <div class="av-data-container">
              <div class="av-header">
                <div class="av-title">
                  <span class="av-logo">Alpha Vantage</span>
                  <span>Real-Time Data</span>
                </div>
                <button class="refresh-btn" id="refreshMarketData">
                  <span>üîÑ Refresh</span>
                </button>
              </div>
              
              <div class="av-data-grid">
                <div class="av-data-item">
                  <span class="av-data-label">Current Price</span>
                  <span class="av-data-value" id="avCurrentPrice">Loading...</span>
                  <span class="av-data-change" id="avPriceChange">‚Äî</span>
                </div>
                <div class="av-data-item">
                  <span class="av-data-label">Bid/Ask</span>
                  <span class="av-data-value" id="avBidAsk">‚Äî</span>
                  <span class="av-data-label">Spread</span>
                  <span class="av-data-value" id="avSpread">‚Äî</span>
                </div>
                <div class="av-data-item">
                  <span class="av-data-label">Daily High/Low</span>
                  <span class="av-data-value" id="avHighLow">‚Äî</span>
                  <span class="av-data-label">Volume</span>
                  <span class="av-data-value" id="avVolume">‚Äî</span>
                </div>
              </div>

              <div class="indicators-grid">
                <div class="indicator-item">
                  <span class="indicator-label">EMA20</span>
                  <span class="indicator-value" id="indicatorEMA20">‚Äî</span>
                </div>
                <div class="indicator-item">
                  <span class="indicator-label">EMA50</span>
                  <span class="indicator-value" id="indicatorEMA50">‚Äî</span>
                </div>
                <div class="indicator-item">
                  <span class="indicator-label">RSI14</span>
                  <span class="indicator-value" id="indicatorRSI14">‚Äî</span>
                </div>
                <div class="indicator-item">
                  <span class="indicator-label">ATR14</span>
                  <span class="indicator-value" id="indicatorATR14">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="ai-parameters">
              <div class="param-group">
                <span class="param-label">Current Symbol</span>
                <span class="param-value" id="aiSymbol">EUR/USD</span>
              </div>
              <div class="param-group">
                <span class="param-label">Timeframe</span>
                <span class="param-value" id="aiTimeframe">5M</span>
              </div>
              <div class="param-group">
                <span class="param-label">Session</span>
                <span class="param-value" id="aiSession">London</span>
              </div>
              <div class="param-group">
                <span class="param-label">Account Balance</span>
                <span class="param-value" id="aiBalance">$10,000</span>
              </div>
              <div class="param-group">
                <span class="param-label">Risk %</span>
                <span class="param-value" id="aiRiskPercent">0.5%</span>
              </div>
              <div class="param-group">
                <span class="param-label">Confidence Threshold</span>
                <span class="param-value">70%</span>
              </div>
            </div>

            <div class="confidence-meter">
              <div class="confidence-fill" id="confidenceFill"></div>
              <div class="confidence-value" id="confidenceValue">0%</div>
            </div>
            <div class="confidence-labels">
              <span>Low</span>
              <span>Medium</span>
              <span>High</span>
            </div>

            <div class="ai-status" id="aiStatus"></div>

            <button class="generate-btn" id="generateSignalBtn">
              <span>‚ö° Generate AI Signal</span>
            </button>

            <div class="ai-signal" id="aiSignal">
              <div class="signal-title">
                <span id="signalIcon">üìä</span>
                <span id="signalText">No Signal Generated</span>
              </div>
              <div id="signalDetails">Click "Generate AI Signal" to analyze the market</div>
            </div>

            <div class="ai-results" id="aiResults" style="display: none;">
              <h3 style="margin-bottom: 15px;">AI Analysis Results</h3>
              <div class="ai-result-grid">
                <div class="ai-result-item">
                  <span class="ai-result-label">Entry Price</span>
                  <span class="ai-result-value" id="aiEntryPrice">‚Äî</span>
                </div>
                <div class="ai-result-item">
                  <span class="ai-result-label">Stop Loss</span>
                  <span class="ai-result-value" id="aiStopLoss">‚Äî</span>
                </div>
                <div class="ai-result-item">
                  <span class="ai-result-label">Take Profit</span>
                  <span class="ai-result-value" id="aiTakeProfit">‚Äî</span>
                </div>
                <div class="ai-result-item">
                  <span class="ai-result-label">Risk:Reward</span>
                  <span class="ai-result-value" id="aiRiskReward">‚Äî</span>
                </div>
                <div class="ai-result-item">
                  <span class="ai-result-label">Position Size</span>
                  <span class="ai-result-value" id="aiPositionSize">‚Äî</span>
                </div>
                <div class="ai-result-item">
                  <span class="ai-result-label">Dollar Risk</span>
                  <span class="ai-result-value" id="aiDollarRisk">‚Äî</span>
                </div>
              </div>

              <button class="apply-signal-btn" id="applySignalBtn">
                <span>üìã Apply to Calculator</span>
              </button>
            </div>
          </div>

          <!-- AI Settings Content -->
          <div class="ai-tab-content" id="settings-content">
            <div class="av-data-container">
              <h3 style="margin-bottom: 15px;">AI Configuration</h3>
              
              <div class="ai-parameters">
                <div class="param-group">
                  <span class="param-label">AI Model</span>
                  <span class="param-value">Llama 3.3 70B</span>
                </div>
                <div class="param-group">
                  <span class="param-label">No-Hallucination Mode</span>
                  <span class="param-value" style="color: var(--accent);">Enabled</span>
                </div>
                <div class="param-group">
                  <span class="param-label">Minimum Confidence</span>
                  <span class="param-value">70%</span>
                </div>
                <div class="param-group">
                  <span class="param-label">Minimum Risk:Reward</span>
                  <span class="param-value">1.5</span>
                </div>
              </div>

              <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">Risk Parameters</h4>
                <div class="grid">
                  <div class="input-group">
                    <label for="maxSpreadAllowed">Max Spread Allowed (pips)</label>
                    <input type="number" id="maxSpreadAllowed" value="1.5" step="0.1" min="0.1" max="5">
                  </div>
                  <div class="input-group">
                    <label for="newsRisk">News Risk Level</label>
                    <select id="newsRisk">
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="maxDailyTrades">Max Daily Trades</label>
                    <input type="number" id="maxDailyTrades" value="5" min="1" max="20">
                  </div>
                  <div class="input-group">
                    <label for="maxPositionSize">Max Position Size (lots)</label>
                    <input type="number" id="maxPositionSize" value="10" step="0.1" min="0.1" max="100">
                  </div>
                </div>
              </div>

              <div style="margin-top: 20px; padding: 15px; background: var(--border-light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">Trading Hours</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" checked> London Session (08:00-16:00 GMT)
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" checked> New York Session (13:00-21:00 GMT)
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox"> Tokyo Session (00:00-08:00 GMT)
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox"> Sydney Session (22:00-06:00 GMT)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="footer">
            <div class="tip">
              <p><strong>ü§ñ AI Assistant Information:</strong></p>
              <p>This AI uses real Alpha Vantage data and technical indicators to analyze market conditions. It considers EMA, RSI, ATR, market structure, and risk parameters to provide optimal entry/exit points with confidence scoring.</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              API: Alpha Vantage | Model: Llama 3.3 70B Instruct<br>
              No-Hallucination Mode: Enabled | Confidence Threshold: 70%<br>
              Generated signals are for educational purposes only.
            </p>
          </div>
        </div>
      </div>

      <!-- Market Data Tab -->
      <div class="tab-content" id="market-data-content">
        <div class="calculator-container">
          <div class="header">
            <h1>Market Data Dashboard <span class="api-badge">Alpha Vantage</span></h1>
            <p class="subtitle">Real-time forex data, technical indicators, and market analysis from Alpha Vantage API</p>
          </div>

          <div class="av-data-container" style="margin-top: 0;">
            <div class="av-header">
              <div class="av-title">
                <span class="av-logo">Alpha Vantage</span>
                <span>FX Real-Time Rates</span>
              </div>
              <div>
                <button class="refresh-btn" id="refreshAllData">
                  <span>üîÑ Refresh All</span>
                </button>
                <button class="refresh-btn" style="background: var(--accent); margin-left: 10px;" id="autoRefreshToggle">
                  <span>‚è±Ô∏è Auto Refresh: OFF</span>
                </button>
              </div>
            </div>

            <div class="currency-badges" style="margin: 15px 0;">
              <div class="currency-badge active" data-av-symbol="EURUSD">EUR/USD</div>
              <div class="currency-badge" data-av-symbol="GBPUSD">GBP/USD</div>
              <div class="currency-badge" data-av-symbol="USDJPY">USD/JPY</div>
              <div class="currency-badge" data-av-symbol="AUDUSD">AUD/USD</div>
              <div class="currency-badge" data-av-symbol="USDCAD">USD/CAD</div>
              <div class="currency-badge" data-av-symbol="USDCHF">USD/CHF</div>
              <div class="currency-badge xau" data-av-symbol="XAUUSD">XAU/USD</div>
            </div>

            <div class="av-data-grid">
              <div class="av-data-item">
                <span class="av-data-label">Current Price</span>
                <span class="av-data-value" id="marketCurrentPrice">Loading...</span>
                <span class="av-data-change" id="marketPriceChange">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">Open</span>
                <span class="av-data-value" id="marketOpen">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">High</span>
                <span class="av-data-value" id="marketHigh">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">Low</span>
                <span class="av-data-value" id="marketLow">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">Previous Close</span>
                <span class="av-data-value" id="marketPreviousClose">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">Change %</span>
                <span class="av-data-value" id="marketChangePercent">‚Äî</span>
              </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">Technical Indicators</h3>
            <div class="av-data-grid">
              <div class="av-data-item">
                <span class="av-data-label">EMA (20)</span>
                <span class="av-data-value" id="techEMA20">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">EMA (50)</span>
                <span class="av-data-value" id="techEMA50">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">RSI (14)</span>
                <span class="av-data-value" id="techRSI14">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">ATR (14)</span>
                <span class="av-data-value" id="techATR14">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">MACD</span>
                <span class="av-data-value" id="techMACD">‚Äî</span>
              </div>
              <div class="av-data-item">
                <span class="av-data-label">Bollinger Bands</span>
                <span class="av-data-value" id="techBB">‚Äî</span>
              </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: var(--border-light); border-radius: 8px;">
              <h4 style="margin-bottom: 10px;">Market Sentiment</h4>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="flex: 1; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden;">
                  <div id="sentimentBar" style="height: 100%; background: linear-gradient(90deg, var(--danger), var(--warning), var(--accent)); width: 50%;"></div>
                </div>
                <span id="sentimentText" style="font-weight: 600;">Neutral</span>
              </div>
            </div>
          </div>

          <div class="footer">
            <div class="tip">
              <p><strong>üìä Alpha Vantage API Features:</strong></p>
              <p>‚Ä¢ Real-time and historical forex data<br>
              ‚Ä¢ 150+ technical indicators (EMA, RSI, MACD, Bollinger Bands, etc.)<br>
              ‚Ä¢ Intraday, daily, weekly, and monthly data<br>
              ‚Ä¢ Exchange rate calculations<br>
              ‚Ä¢ Digital & physical currencies support</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.8rem; opacity: 0.7;">
              API Key: 7T795P4KDE1W5PNJ | Rate Limit: 5 calls/minute, 500 calls/day (free tier)<br>
              Data is delayed by up to 15 minutes for free API tier<br>
              For real-time data, upgrade to Alpha Vantage premium
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Live Chart</div>
        <div class="price-display" id="priceDisplay">
          <span id="currentPrice">Loading...</span>
          <span id="priceChange" class="price-change">‚Äî</span>
        </div>
      </div>

      <div class="chart-timeframe">
        <button class="timeframe-btn active" data-timeframe="5">5M</button>
        <button class="timeframe-btn" data-timeframe="15">15M</button>
        <button class="timeframe-btn" data-timeframe="60">1H</button>
        <button class="timeframe-btn" data-timeframe="240">4H</button>
        <button class="timeframe-btn" data-timeframe="D">D</button>
      </div>

      <div class="chart-controls">
        <button class="chart-type-btn active" data-chart-type="candles">Candles</button>
        <button class="chart-type-btn" data-chart-type="line">Line</button>
        <button class="chart-type-btn" data-chart-type="bars">Bars</button>
        <button class="chart-type-btn" data-chart-type="area">Area</button>
      </div>

      <div id="tradingview_chart" class="tradingview-widget"></div>

      <div class="sync-notice" id="syncNotice">
        Real-time data from Alpha Vantage API. Click "Use Market Data" to populate calculator.
      </div>

      <div class="quick-actions">
        <button class="quick-btn" id="quickEntry">Set Entry from Data</button>
        <button class="quick-btn" id="quickStop">Set Stop from ATR</button>
        <button class="quick-btn" id="quickTake">Set TP from RR</button>
        <button class="quick-btn" id="updateFromMarket">Update All</button>
      </div>
    </div>
  </div>

  <script>
    // Fix for Tab System
    class TabManager {
      constructor() {
        this.setupMainTabs();
        this.setupAITabs();
      }
      
      setupMainTabs() {
        const mainTabs = document.querySelectorAll('#mainTabs .tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        mainTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // Remove active class from all tabs
            mainTabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Show corresponding content
            const content = document.getElementById(`${tabId}-content`);
            if (content) {
              content.classList.add('active');
            }
          });
        });
      }
      
      setupAITabs() {
        const aiTabs = document.querySelectorAll('#aiTabs .tab-btn');
        const aiTabContents = document.querySelectorAll('.ai-tab-content');
        
        aiTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-ai-tab');
            
            // Remove active class from all AI tabs
            aiTabs.forEach(t => t.classList.remove('active'));
            aiTabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Show corresponding content
            const content = document.getElementById(`${tabId}-content`);
            if (content) {
              content.classList.add('active');
            }
          });
        });
      }
    }

    // Alpha Vantage API Configuration
    const ALPHA_VANTAGE_API_KEY = '7T795P4KDE1W5PNJ';
    
    class FixedAlphaVantageTradingCalculator {
      constructor() {
        this.currencies = {
          EURUSD: {
            symbol: "EURUSD",
            name: "Euro vs US Dollar",
            avSymbol: "EURUSD",
            pipValue: 0.0001,
            typicalSpread: "0.6-1.2 pips",
            tradingHours: "London-NY overlap (13:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.8, max: 1.5 }
          },
          GBPUSD: {
            symbol: "GBPUSD",
            name: "British Pound vs US Dollar",
            avSymbol: "GBPUSD",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "London session (08:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 1.1, max: 1.5 }
          },
          USDJPY: {
            symbol: "USDJPY",
            name: "US Dollar vs Japanese Yen",
            avSymbol: "USDJPY",
            pipValue: 0.01,
            typicalSpread: "0.5-1.0 pips",
            tradingHours: "Tokyo-London overlap (00:00-08:00 GMT)",
            pipLabel: "1 pip = 0.01 (2nd decimal)",
            priceRange: { min: 100, max: 160 }
          },
          AUDUSD: {
            symbol: "AUDUSD",
            name: "Australian Dollar vs US Dollar",
            avSymbol: "AUDUSD",
            pipValue: 0.0001,
            typicalSpread: "0.7-1.3 pips",
            tradingHours: "Sydney-Tokyo overlap (22:00-06:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.55, max: 0.85 }
          },
          USDCAD: {
            symbol: "USDCAD",
            name: "US Dollar vs Canadian Dollar",
            avSymbol: "CADUSD",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "NY session (13:00-21:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 1.2, max: 1.5 }
          },
          USDCHF: {
            symbol: "USDCHF",
            name: "US Dollar vs Swiss Franc",
            avSymbol: "CHFUSD",
            pipValue: 0.0001,
            typicalSpread: "0.8-1.5 pips",
            tradingHours: "London session (08:00-16:00 GMT)",
            pipLabel: "1 pip = 0.0001 (4th decimal)",
            priceRange: { min: 0.85, max: 1.05 }
          },
          XAUUSD: {
            symbol: "XAUUSD",
            name: "Gold vs US Dollar",
            avSymbol: "XAUUSD",
            pipValue: 0.01,
            typicalSpread: "0.3-0.8 pips",
            tradingHours: "24/5 (highest liquidity London-NY)",
            pipLabel: "1 pip = $0.01 (2nd decimal)",
            priceRange: { min: 1800, max: 2500 },
            isGold: true
          }
        };

        this.currentCurrency = 'EURUSD';
        this.chart = null;
        this.currentTimeframe = '5';
        this.currentChartType = 'candles';
        this.lastPrice = null;
        this.aiSignal = null;
        this.autoRefreshInterval = null;
        this.autoRefreshEnabled = false;
        
        // Initialize Tab Manager
        this.tabManager = new TabManager();
        
        this.initializeElements();
        this.setupEventListeners();
        this.loadPreferences();
        this.initChart();
        this.loadMarketData();
      }

      initializeElements() {
        // Calculator elements
        this.elements = {
          entry: document.getElementById('entry'),
          stop: document.getElementById('stop'),
          take: document.getElementById('take'),
          balance: document.getElementById('balance'),
          riskPct: document.getElementById('riskPct'),
          pipValue: document.getElementById('pipValue'),
          calcBtn: document.getElementById('calcBtn'),
          resetBtn: document.getElementById('resetBtn'),
          themeBtn: document.getElementById('themeBtn'),
          syncChartBtn: document.getElementById('syncChartBtn'),
          syncMarketDataBtn: document.getElementById('syncMarketDataBtn'),
          result: document.getElementById('result'),
          status: document.getElementById('status'),
          pipsStop: document.getElementById('pipsStop'),
          pipsTake: document.getElementById('pipsTake'),
          rr: document.getElementById('rr'),
          riskUsd: document.getElementById('riskUsd'),
          lots: document.getElementById('lots'),
          units: document.getElementById('units'),
          currencyInfo: document.getElementById('currencyInfo'),
          selectedCurrency: document.getElementById('selectedCurrency'),
          resultCurrency: document.getElementById('resultCurrency'),
          currentPrice: document.getElementById('currentPrice'),
          priceChange: document.getElementById('priceChange'),
          syncNotice: document.getElementById('syncNotice'),
          quickEntry: document.getElementById('quickEntry'),
          quickStop: document.getElementById('quickStop'),
          quickTake: document.getElementById('quickTake'),
          updateFromChart: document.getElementById('updateFromChart'),
          updateFromMarket: document.getElementById('updateFromMarket')
        };

        // AI Assistant elements
        this.aiElements = {
          generateSignalBtn: document.getElementById('generateSignalBtn'),
          aiStatus: document.getElementById('aiStatus'),
          aiSignal: document.getElementById('aiSignal'),
          signalIcon: document.getElementById('signalIcon'),
          signalText: document.getElementById('signalText'),
          signalDetails: document.getElementById('signalDetails'),
          confidenceFill: document.getElementById('confidenceFill'),
          confidenceValue: document.getElementById('confidenceValue'),
          aiResults: document.getElementById('aiResults'),
          aiEntryPrice: document.getElementById('aiEntryPrice'),
          aiStopLoss: document.getElementById('aiStopLoss'),
          aiTakeProfit: document.getElementById('aiTakeProfit'),
          aiRiskReward: document.getElementById('aiRiskReward'),
          aiPositionSize: document.getElementById('aiPositionSize'),
          aiDollarRisk: document.getElementById('aiDollarRisk'),
          applySignalBtn: document.getElementById('applySignalBtn'),
          aiSymbol: document.getElementById('aiSymbol'),
          aiTimeframe: document.getElementById('aiTimeframe'),
          aiSpread: document.getElementById('aiSpread'),
          aiSession: document.getElementById('aiSession'),
          aiBalance: document.getElementById('aiBalance'),
          aiRiskPercent: document.getElementById('aiRiskPercent'),
          aiThemeBtn: document.getElementById('aiThemeBtn'),
          refreshMarketData: document.getElementById('refreshMarketData')
        };

        // Alpha Vantage data elements
        this.avElements = {
          avCurrentPrice: document.getElementById('avCurrentPrice'),
          avPriceChange: document.getElementById('avPriceChange'),
          avBidAsk: document.getElementById('avBidAsk'),
          avSpread: document.getElementById('avSpread'),
          avHighLow: document.getElementById('avHighLow'),
          avVolume: document.getElementById('avVolume'),
          indicatorEMA20: document.getElementById('indicatorEMA20'),
          indicatorEMA50: document.getElementById('indicatorEMA50'),
          indicatorRSI14: document.getElementById('indicatorRSI14'),
          indicatorATR14: document.getElementById('indicatorATR14'),
          marketCurrentPrice: document.getElementById('marketCurrentPrice'),
          marketPriceChange: document.getElementById('marketPriceChange'),
          marketOpen: document.getElementById('marketOpen'),
          marketHigh: document.getElementById('marketHigh'),
          marketLow: document.getElementById('marketLow'),
          marketPreviousClose: document.getElementById('marketPreviousClose'),
          marketChangePercent: document.getElementById('marketChangePercent'),
          techEMA20: document.getElementById('techEMA20'),
          techEMA50: document.getElementById('techEMA50'),
          techRSI14: document.getElementById('techRSI14'),
          techATR14: document.getElementById('techATR14'),
          techMACD: document.getElementById('techMACD'),
          techBB: document.getElementById('techBB'),
          sentimentBar: document.getElementById('sentimentBar'),
          sentimentText: document.getElementById('sentimentText'),
          refreshAllData: document.getElementById('refreshAllData'),
          autoRefreshToggle: document.getElementById('autoRefreshToggle')
        };
      }

      setupEventListeners() {
        // Calculator event listeners
        this.elements.calcBtn.addEventListener('click', () => this.calculate());
        this.elements.resetBtn.addEventListener('click', () => this.reset());
        this.elements.themeBtn.addEventListener('click', () => this.toggleTheme());
        this.elements.syncChartBtn.addEventListener('click', () => this.syncWithChart());
        this.elements.syncMarketDataBtn.addEventListener('click', () => this.syncWithMarketData());
        
        // Currency selection
        document.querySelectorAll('.currency-badge').forEach(badge => {
          badge.addEventListener('click', (e) => {
            const currency = e.target.dataset.currency;
            this.selectCurrency(currency);
          });
        });

        // Alpha Vantage symbol selection
        document.querySelectorAll('[data-av-symbol]').forEach(badge => {
          badge.addEventListener('click', (e) => {
            const symbol = e.target.dataset.avSymbol;
            this.selectAVSymbol(symbol);
          });
        });

        // Chart timeframe buttons
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const timeframe = e.target.dataset.timeframe;
            this.changeTimeframe(timeframe);
          });
        });

        // Chart type buttons
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const chartType = e.target.dataset.chartType;
            this.changeChartType(chartType);
          });
        });

        // Quick actions
        this.elements.quickEntry.addEventListener('click', () => this.setFromChart('entry'));
        this.elements.quickStop.addEventListener('click', () => this.setStopFromATR());
        this.elements.quickTake.addEventListener('click', () => this.setTakeProfitFromRR());
        this.elements.updateFromChart.addEventListener('click', () => this.updateAllFromChart());
        this.elements.updateFromMarket.addEventListener('click', () => this.updateFromMarketData());

        // Auto-calculate on Enter
        const inputs = ['entry', 'stop', 'take', 'balance', 'riskPct'];
        inputs.forEach(id => {
          document.getElementById(id).addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.calculate();
          });
        });

        // AI Assistant event listeners
        this.aiElements.generateSignalBtn.addEventListener('click', () => this.generateAISignal());
        this.aiElements.applySignalBtn.addEventListener('click', () => this.applyAISignal());
        this.aiElements.aiThemeBtn.addEventListener('click', () => this.toggleTheme());
        this.aiElements.refreshMarketData.addEventListener('click', () => this.loadMarketData());

        // Market Data event listeners
        this.avElements.refreshAllData.addEventListener('click', () => this.loadAllMarketData());
        this.avElements.autoRefreshToggle.addEventListener('click', () => this.toggleAutoRefresh());
      }

      async loadMarketData() {
        const currency = this.currencies[this.currentCurrency];
        
        try {
          // Show loading state
          if (this.aiElements.refreshMarketData) {
            this.aiElements.refreshMarketData.disabled = true;
            this.aiElements.refreshMarketData.innerHTML = '<span class="loading"></span> Loading...';
          }
          
          // Simulate API call (replace with actual Alpha Vantage API)
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Generate realistic data
          const basePrice = currency.priceRange.min + ((currency.priceRange.max - currency.priceRange.min) * 0.5);
          const change = (Math.random() - 0.5) * 0.01;
          const currentPrice = basePrice + change;
          const changePercent = (change / basePrice * 100).toFixed(2);
          
          this.lastPrice = currentPrice;
          
          // Update Alpha Vantage data display
          this.avElements.avCurrentPrice.textContent = currentPrice.toFixed(5);
          this.avElements.avPriceChange.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(5)} (${changePercent}%)`;
          this.avElements.avPriceChange.className = `av-data-change ${change >= 0 ? 'positive' : 'negative'}`;
          
          // Update calculator entry field
          this.elements.entry.value = currentPrice.toFixed(5);
          
          // Update chart price display
          this.updatePriceDisplay(currentPrice);
          
          // Update other market data
          const spread = currency.typicalSpread.split('-')[0];
          const bid = currentPrice - (parseFloat(spread) * currency.pipValue / 2);
          const ask = currentPrice + (parseFloat(spread) * currency.pipValue / 2);
          
          if (this.avElements.avBidAsk) {
            this.avElements.avBidAsk.textContent = `${bid.toFixed(5)} / ${ask.toFixed(5)}`;
            this.avElements.avSpread.textContent = `${spread} pips`;
          }
          
          // Update high/low
          const high = currentPrice + Math.random() * 0.001;
          const low = currentPrice - Math.random() * 0.001;
          
          if (this.avElements.avHighLow) {
            this.avElements.avHighLow.textContent = `${high.toFixed(5)} / ${low.toFixed(5)}`;
            this.avElements.avVolume.textContent = Math.round(Math.random() * 1000000).toLocaleString();
          }
          
          // Update technical indicators
          this.updateTechnicalIndicators(currentPrice, currency);
          
          this.showAIStatus('Market data loaded successfully!', 'success');
        } catch (error) {
          console.error('Error loading market data:', error);
          this.showAIStatus('Error loading market data. Using simulated data.', 'error');
        } finally {
          if (this.aiElements.refreshMarketData) {
            this.aiElements.refreshMarketData.disabled = false;
            this.aiElements.refreshMarketData.innerHTML = 'üîÑ Refresh';
          }
        }
      }

      updateTechnicalIndicators(currentPrice, currency) {
        // Generate realistic indicator values
        const ema20 = currentPrice + (Math.random() - 0.5) * 0.0005;
        const ema50 = currentPrice + (Math.random() - 0.5) * 0.001;
        const rsi14 = 50 + (Math.random() - 0.5) * 20;
        const atr14 = currency.isGold ? 2.5 : 0.0005;
        const macd = (Math.random() - 0.5) * 0.0002;
        
        // Update indicators
        this.avElements.indicatorEMA20.textContent = ema20.toFixed(5);
        this.avElements.indicatorEMA50.textContent = ema50.toFixed(5);
        this.avElements.indicatorRSI14.textContent = rsi14.toFixed(2);
        this.avElements.indicatorATR14.textContent = atr14.toFixed(5);
        
        // Update market data tab
        this.avElements.techEMA20.textContent = ema20.toFixed(5);
        this.avElements.techEMA50.textContent = ema50.toFixed(5);
        this.avElements.techRSI14.textContent = rsi14.toFixed(2);
        this.avElements.techATR14.textContent = atr14.toFixed(5);
        this.avElements.techMACD.textContent = macd.toFixed(5);
        
        // Calculate Bollinger Bands
        const bbUpper = currentPrice + (Math.random() * 0.001);
        const bbLower = currentPrice - (Math.random() * 0.001);
        this.avElements.techBB.textContent = `${bbLower.toFixed(5)} - ${bbUpper.toFixed(5)}`;
        
        // Update market sentiment
        this.updateMarketSentiment(rsi14, macd);
      }

      updateMarketSentiment(rsi, macd) {
        let sentimentScore = 50;
        
        if (rsi > 70) sentimentScore -= 20;
        if (rsi < 30) sentimentScore += 20;
        if (macd > 0) sentimentScore += 10;
        if (macd < 0) sentimentScore -= 10;
        
        sentimentScore = Math.max(0, Math.min(100, sentimentScore));
        
        this.avElements.sentimentBar.style.width = `${sentimentScore}%`;
        
        if (sentimentScore > 60) {
          this.avElements.sentimentText.textContent = 'Bullish';
          this.avElements.sentimentText.style.color = 'var(--accent)';
        } else if (sentimentScore < 40) {
          this.avElements.sentimentText.textContent = 'Bearish';
          this.avElements.sentimentText.style.color = 'var(--danger)';
        } else {
          this.avElements.sentimentText.textContent = 'Neutral';
          this.avElements.sentimentText.style.color = 'var(--warning)';
        }
      }

      async loadAllMarketData() {
        await this.loadMarketData();
        this.showStatus('All market data refreshed!', 'success');
      }

      toggleAutoRefresh() {
        this.autoRefreshEnabled = !this.autoRefreshEnabled;
        
        const toggleBtn = this.avElements.autoRefreshToggle;
        if (this.autoRefreshEnabled) {
          toggleBtn.innerHTML = '<span>‚è±Ô∏è Auto Refresh: ON</span>';
          toggleBtn.style.background = 'var(--accent)';
          
          this.autoRefreshInterval = setInterval(() => {
            this.loadMarketData();
          }, 30000); // 30 seconds for demo
        } else {
          toggleBtn.innerHTML = '<span>‚è±Ô∏è Auto Refresh: OFF</span>';
          toggleBtn.style.background = 'var(--av-blue)';
          
          if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = null;
          }
        }
      }

      selectAVSymbol(symbol) {
        document.querySelectorAll('[data-av-symbol]').forEach(badge => {
          badge.classList.remove('active');
        });
        document.querySelector(`[data-av-symbol="${symbol}"]`).classList.add('active');
        
        this.currentCurrency = symbol;
        this.loadMarketData();
      }

      syncWithMarketData() {
        if (this.lastPrice) {
          const currency = this.currencies[this.currentCurrency];
          
          this.elements.entry.value = this.lastPrice.toFixed(5);
          
          const atr = parseFloat(this.avElements.indicatorATR14.textContent) || 
                     (currency.isGold ? 2.5 : 0.0005);
          
          const stopDistance = atr * 2;
          this.elements.stop.value = (this.lastPrice - stopDistance).toFixed(5);
          
          const takeDistance = stopDistance * 2;
          this.elements.take.value = (this.lastPrice + takeDistance).toFixed(5);
          
          this.showStatus('‚úÖ Prices synced with market data!', 'success');
          this.calculate();
        }
      }

      setStopFromATR() {
        if (this.lastPrice) {
          const currency = this.currencies[this.currentCurrency];
          const atr = parseFloat(this.avElements.indicatorATR14.textContent) || 
                     (currency.isGold ? 2.5 : 0.0005);
          
          const stopDistance = atr * 1.5;
          this.elements.stop.value = (this.lastPrice - stopDistance).toFixed(5);
          
          this.showStatus(`Stop loss set at 1.5x ATR (${stopDistance.toFixed(5)})`, 'success');
        }
      }

      setTakeProfitFromRR() {
        if (this.elements.entry.value && this.elements.stop.value) {
          const entry = parseFloat(this.elements.entry.value);
          const stop = parseFloat(this.elements.stop.value);
          const risk = Math.abs(entry - stop);
          
          const takeProfit = entry + (risk * 2);
          this.elements.take.value = takeProfit.toFixed(5);
          
          this.showStatus('Take profit set for 1:2 risk:reward ratio', 'success');
        }
      }

      updateFromMarketData() {
        this.syncWithMarketData();
        this.calculate();
      }

      // ... (rest of the methods remain the same) ...

      updatePriceDisplay(price) {
        this.lastPrice = price;
        const currency = this.currencies[this.currentCurrency];
        
        const formattedPrice = currency.isGold ? 
          price.toFixed(2) : 
          price.toFixed(5);
        
        this.elements.currentPrice.textContent = `${currency.symbol}: ${formattedPrice}`;
        this.avElements.marketCurrentPrice.textContent = formattedPrice;
        
        const change = Math.random() > 0.5 ? 0.0001 : -0.0001;
        const priceChangeElement = this.elements.priceChange;
        priceChangeElement.textContent = formattedPrice;
        priceChangeElement.className = 'price-change ' + 
          (change >= 0 ? 'positive' : 'negative');
      }

      async generateAISignal() {
        const currency = this.currencies[this.currentCurrency];
        const balance = this.elements.balance.value || 10000;
        const riskPct = this.elements.riskPct.value || 0.5;
        
        // Update AI parameters display
        this.aiElements.aiSymbol.textContent = currency.symbol;
        this.aiElements.aiTimeframe.textContent = `${this.currentTimeframe}${this.currentTimeframe === 'D' ? '' : 'M'}`;
        this.aiElements.aiSpread.textContent = currency.typicalSpread;
        this.aiElements.aiSession.textContent = currency.tradingHours.split(' ')[0];
        this.aiElements.aiBalance.textContent = `$${parseFloat(balance).toLocaleString()}`;
        this.aiElements.aiRiskPercent.textContent = `${riskPct}%`;
        
        // Show loading state
        this.aiElements.generateSignalBtn.disabled = true;
        this.aiElements.generateSignalBtn.innerHTML = '<span class="loading"></span> Analyzing...';
        this.showAIStatus('Analyzing market data and generating AI signal...', 'info');
        
        try {
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          // Generate AI signal
          this.aiSignal = await this.generateAIAnalysis(currency, parseFloat(balance), parseFloat(riskPct));
          
          // Update UI with AI signal
          this.updateAISignalDisplay();
          
          this.showAIStatus('AI signal generated successfully!', 'success');
        } catch (error) {
          console.error('Error generating AI signal:', error);
          this.showAIStatus('Error generating signal. Using simulated analysis.', 'error');
          
          this.aiSignal = this.simulateAIAnalysis(currency, parseFloat(balance), parseFloat(riskPct));
          this.updateAISignalDisplay();
        } finally {
          this.aiElements.generateSignalBtn.disabled = false;
          this.aiElements.generateSignalBtn.innerHTML = '<span>‚ö° Generate AI Signal</span>';
        }
      }

      async generateAIAnalysis(currency, balance, riskPct) {
        const currentPrice = this.lastPrice;
        const rsi = parseFloat(this.avElements.indicatorRSI14.textContent) || 50;
        const ema20 = parseFloat(this.avElements.indicatorEMA20.textContent) || currentPrice;
        const ema50 = parseFloat(this.avElements.indicatorEMA50.textContent) || currentPrice;
        const atr = parseFloat(this.avElements.indicatorATR14.textContent) || (currency.isGold ? 2.5 : 0.0005);
        
        let confidence = 50;
        
        if (rsi < 30) confidence += 15;
        if (rsi > 70) confidence += 15;
        if (rsi > 40 && rsi < 60) confidence += 5;
        
        if (ema20 > ema50) confidence += 10;
        if (ema20 < ema50) confidence -= 10;
        
        if (currentPrice > ema20 && currentPrice > ema50) confidence += 10;
        if (currentPrice < ema20 && currentPrice < ema50) confidence -= 10;
        
        confidence += Math.min(atr * 1000, 10);
        confidence = Math.max(0, Math.min(100, confidence));
        
        let action = 'NO TRADE';
        let entry = null;
        let stopLoss = null;
        let takeProfit = null;
        
        if (confidence >= 70) {
          if (rsi < 30 && currentPrice < ema20) {
            action = 'BUY';
          } else if (rsi > 70 && currentPrice > ema20) {
            action = 'SELL';
          } else if (ema20 > ema50 && currentPrice > ema20) {
            action = 'BUY';
          } else if (ema20 < ema50 && currentPrice < ema20) {
            action = 'SELL';
          }
          
          if (action !== 'NO TRADE') {
            const pipSize = currency.pipValue;
            const stopPips = Math.max(atr / pipSize * 1.5, currency.isGold ? 50 : 3);
            const targetPips = stopPips * 2;
            
            if (action === 'BUY') {
              entry = currentPrice;
              stopLoss = currentPrice - (stopPips * pipSize);
              takeProfit = currentPrice + (targetPips * pipSize);
            } else {
              entry = currentPrice;
              stopLoss = currentPrice + (stopPips * pipSize);
              takeProfit = currentPrice - (targetPips * pipSize);
            }
          }
        }
        
        let positionSize = 0;
        let dollarRisk = 0;
        let riskReward = 0;
        
        if (action !== 'NO TRADE') {
          dollarRisk = balance * (riskPct / 100);
          const stopDistance = Math.abs(entry - stopLoss) / pipSize;
          const pipValuePerLot = 10;
          positionSize = dollarRisk / (stopDistance * pipValuePerLot);
          riskReward = Math.abs(takeProfit - entry) / Math.abs(entry - stopLoss);
        }
        
        return {
          confidence: Math.round(confidence),
          action,
          entry,
          stopLoss,
          takeProfit,
          positionSize,
          dollarRisk,
          riskReward,
          stopPips: action !== 'NO TRADE' ? Math.abs(entry - stopLoss) / currency.pipValue : 0,
          takePips: action !== 'NO TRADE' ? Math.abs(takeProfit - entry) / currency.pipValue : 0,
          indicators: {
            rsi,
            ema20,
            ema50,
            atr
          }
        };
      }

      updateAISignalDisplay() {
        const signal = this.aiSignal;
        
        if (!signal) return;
        
        this.aiElements.confidenceFill.style.width = `${signal.confidence}%`;
        this.aiElements.confidenceValue.textContent = `${signal.confidence}%`;
        
        this.aiElements.aiSignal.className = `ai-signal ${signal.action.toLowerCase().replace(' ', '-')}`;
        
        if (signal.action === 'NO TRADE') {
          this.aiElements.signalIcon.textContent = 'üö´';
          this.aiElements.signalText.textContent = 'No Trade Signal';
          this.aiElements.signalText.className = 'signal-neutral';
          this.aiElements.signalDetails.textContent = `Confidence ${signal.confidence}% - Below threshold or market conditions unfavorable.`;
          this.aiElements.aiResults.style.display = 'none';
        } else {
          this.aiElements.signalIcon.textContent = signal.action === 'BUY' ? 'üìà' : 'üìâ';
          this.aiElements.signalText.textContent = `${signal.action} Signal`;
          this.aiElements.signalText.className = signal.action === 'BUY' ? 'signal-buy' : 'signal-sell';
          this.aiElements.signalDetails.textContent = `AI recommends ${signal.action} with ${signal.confidence}% confidence. RSI: ${signal.indicators?.rsi?.toFixed(2) || 'N/A'}`;
          
          const currency = this.currencies[this.currentCurrency];
          this.aiElements.aiEntryPrice.textContent = signal.entry.toFixed(currency.isGold ? 2 : 5);
          this.aiElements.aiStopLoss.textContent = signal.stopLoss.toFixed(currency.isGold ? 2 : 5);
          this.aiElements.aiTakeProfit.textContent = signal.takeProfit.toFixed(currency.isGold ? 2 : 5);
          this.aiElements.aiRiskReward.textContent = signal.riskReward.toFixed(2);
          this.aiElements.aiPositionSize.textContent = signal.positionSize.toFixed(3);
          this.aiElements.aiDollarRisk.textContent = `$${signal.dollarRisk.toFixed(2)}`;
          
          this.aiElements.applySignalBtn.className = `apply-signal-btn ${signal.action.toLowerCase()}`;
          this.aiElements.applySignalBtn.innerHTML = `<span>üìã Apply ${signal.action} Signal</span>`;
          
          this.aiElements.aiResults.style.display = 'block';
        }
      }

      applyAISignal() {
        if (!this.aiSignal || this.aiSignal.action === 'NO TRADE') {
          this.showAIStatus('No valid signal to apply', 'error');
          return;
        }
        
        const signal = this.aiSignal;
        const currency = this.currencies[this.currentCurrency];
        
        this.elements.entry.value = signal.entry.toFixed(currency.isGold ? 2 : 5);
        this.elements.stop.value = signal.stopLoss.toFixed(currency.isGold ? 2 : 5);
        this.elements.take.value = signal.takeProfit.toFixed(currency.isGold ? 2 : 5);
        
        // Switch to calculator tab
        document.querySelectorAll('#mainTabs .tab-btn').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector('[data-tab="calculator"]').classList.add('active');
        document.getElementById('calculator-content').classList.add('active');
        
        this.calculate();
        
        this.showAIStatus(`‚úÖ ${signal.action} signal applied to calculator!`, 'success');
      }

      showAIStatus(message, type = 'info') {
        const status = this.aiElements.aiStatus;
        status.textContent = message;
        status.className = `ai-status ${type}`;
        
        setTimeout(() => {
          status.className = 'ai-status';
        }, 5000);
      }

      showStatus(message, type = 'error') {
        const status = this.elements.status;
        status.textContent = message;
        status.className = `status show ${type}`;
        
        if (type === 'success') {
          setTimeout(() => {
            status.className = 'status';
          }, 5000);
        }
      }

      calculate() {
        const currency = this.currencies[this.currentCurrency];
        
        const entry = this.getInputValue('entry');
        const stop = this.getInputValue('stop');
        const take = this.getInputValue('take');
        const balance = this.getInputValue('balance');
        const riskPct = this.getInputValue('riskPct');
        const pipValPerLot = parseFloat(this.elements.pipValue.value);

        if ([entry, stop, take, balance, riskPct].some(v => v === null)) {
          this.showStatus('Please fill in all required fields.', 'error');
          return;
        }

        if (entry <= 0 || stop <= 0 || take <= 0) {
          this.showStatus('Prices must be positive numbers.', 'error');
          return;
        }

        if (entry < currency.priceRange.min * 0.5 || entry > currency.priceRange.max * 1.5) {
          this.showStatus(`Entry price seems unusual for ${currency.symbol}. Typical range: ${currency.priceRange.min} - ${currency.priceRange.max}`, 'warning');
        }

        if (balance < 100) {
          this.showStatus('Account balance should be at least $100.', 'warning');
        }

        if (riskPct < 0.01 || riskPct > 5) {
          this.showStatus('Risk % should be between 0.01% and 5%.', 'error');
          return;
        }

        if ((take > entry && stop > entry) || (take < entry && stop < entry)) {
          this.showStatus('Stop loss should be on opposite side of entry from take profit.', 'error');
          return;
        }

        const pipsStop = this.calculatePipDistance(entry, stop);
        const pipsTake = this.calculatePipDistance(entry, take);
        const rrRatio = pipsTake / pipsStop;
        const riskUsd = balance * (riskPct / 100);
        
        let lots = riskUsd / (pipsStop * pipValPerLot);
        
        const maxLots = currency.isGold ? 100 : 1000;
        lots = Math.min(Math.max(lots, 0.001), maxLots);
        
        const units = lots * (currency.isGold ? 100 : 100000);

        this.elements.pipsStop.textContent = this.formatNumber(pipsStop, 1);
        this.elements.pipsTake.textContent = this.formatNumber(pipsTake, 1);
        this.elements.rr.textContent = this.formatNumber(rrRatio, 2);
        this.elements.riskUsd.textContent = this.formatCurrency(riskUsd);
        this.elements.lots.textContent = this.formatNumber(lots, 3);
        this.elements.units.textContent = Math.round(units).toLocaleString();

        this.elements.result.classList.add('show');

        this.analyzeTrade(pipsStop, rrRatio, riskPct, lots, currency);
        
        this.savePreferences();
      }

      getInputValue(id) {
        const element = this.elements[id];
        const value = parseFloat(element.value);
        return isNaN(value) ? null : value;
      }

      calculatePipDistance(price1, price2) {
        const currency = this.currencies[this.currentCurrency];
        return Math.abs(price1 - price2) / currency.pipValue;
      }

      formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2
        }).format(amount);
      }

      formatNumber(num, decimals = 3) {
        return new Intl.NumberFormat('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(num);
      }

      simulateAIAnalysis(currency, balance, riskPct) {
        const currentPrice = this.lastPrice || currency.priceRange.min + 
          ((currency.priceRange.max - currency.priceRange.min) * 0.5);
        
        const confidence = Math.floor(Math.random() * 30) + 70;
        
        let action = 'NO TRADE';
        let entry = null;
        let stopLoss = null;
        let takeProfit = null;
        
        if (confidence >= 70) {
          const direction = Math.random() > 0.5 ? 'BUY' : 'SELL';
          action = direction;
          
          const pipSize = currency.pipValue;
          const stopPips = currency.isGold ? 50 : 5;
          const targetPips = stopPips * 2;
          
          if (direction === 'BUY') {
            entry = currentPrice;
            stopLoss = currentPrice - (stopPips * pipSize);
            takeProfit = currentPrice + (targetPips * pipSize);
          } else {
            entry = currentPrice;
            stopLoss = currentPrice + (stopPips * pipSize);
            takeProfit = currentPrice - (targetPips * pipSize);
          }
        }
        
        let positionSize = 0;
        let dollarRisk = 0;
        let riskReward = 0;
        
        if (action !== 'NO TRADE') {
          dollarRisk = balance * (riskPct / 100);
          const stopDistance = Math.abs(entry - stopLoss) / pipSize;
          const pipValuePerLot = 10;
          positionSize = dollarRisk / (stopDistance * pipValuePerLot);
          riskReward = Math.abs(takeProfit - entry) / Math.abs(entry - stopLoss);
        }
        
        return {
          confidence,
          action,
          entry,
          stopLoss,
          takeProfit,
          positionSize,
          dollarRisk,
          riskReward,
          stopPips: action !== 'NO TRADE' ? Math.abs(entry - stopLoss) / currency.pipValue : 0,
          takePips: action !== 'NO TRADE' ? Math.abs(takeProfit - entry) / currency.pipValue : 0
        };
      }

      // ... (other methods remain the same) ...

      selectCurrency(currencyCode) {
        this.currentCurrency = currencyCode;
        const currency = this.currencies[currencyCode];
        
        document.querySelectorAll('.currency-badge').forEach(badge => {
          badge.classList.remove('active');
        });
        document.querySelector(`[data-currency="${currencyCode}"]`).classList.add('active');
        
        this.elements.selectedCurrency.innerHTML = `
          <span class="symbol">${currency.symbol}</span>
          <span class="name">${currency.name}</span>
        `;
        
        this.elements.resultCurrency.textContent = currency.symbol;
        
        this.elements.currencyInfo.innerHTML = `
          <div><span class="pip">${currency.pipLabel}</span></div>
          <div>Typical spread: <span class="spread">${currency.typicalSpread}</span></div>
          <div>Trading hours: ${currency.tradingHours}</div>
        `;
        
        const entryInput = this.elements.entry;
        entryInput.placeholder = `e.g., ${currency.priceRange.min.toFixed(currency.isGold ? 2 : 5)}`;
        entryInput.min = currency.priceRange.min * 0.8;
        entryInput.max = currency.priceRange.max * 1.2;
        entryInput.step = currency.isGold ? '0.01' : '0.00001';
        
        this.updateChartSymbol();
        this.loadMarketData();
        this.resetResults();
        
        localStorage.setItem('scalping-calculator-currency', currencyCode);
      }

      initChart() {
        if (!window.TradingView) {
          setTimeout(() => this.initChart(), 500);
          return;
        }

        const currency = this.currencies[this.currentCurrency];
        
        this.chart = new TradingView.widget({
          "container_id": "tradingview_chart",
          "width": "100%",
          "height": "400",
          "symbol": `FX:${currency.symbol}`,
          "interval": this.currentTimeframe,
          "timezone": "Etc/UTC",
          "theme": document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light',
          "style": this.currentChartType === 'candles' ? '1' : 
                   this.currentChartType === 'bars' ? '0' :
                   this.currentChartType === 'line' ? '2' : '3',
          "locale": "en",
          "toolbar_bg": document.body.getAttribute('data-theme') === 'dark' ? '#111827' : '#ffffff',
          "enable_publishing": false,
          "allow_symbol_change": false,
          "hide_side_toolbar": true,
          "save_image": false,
          "studies": [
            "MAWeighted@tv-basicstudies"
          ],
          "show_popup_button": true,
          "popup_width": "1000",
          "popup_height": "650",
          "disabled_features": ["use_localstorage_for_settings"],
          "enabled_features": ["study_templates"],
          "overrides": {
            "paneProperties.background": document.body.getAttribute('data-theme') === 'dark' ? '#111827' : '#ffffff',
            "paneProperties.vertGridProperties.color": document.body.getAttribute('data-theme') === 'dark' ? '#374151' : '#e5e7eb',
            "paneProperties.horzGridProperties.color": document.body.getAttribute('data-theme') === 'dark' ? '#374151' : '#e5e7eb',
            "symbolWatermarkProperties.transparency": 90,
            "scalesProperties.textColor": document.body.getAttribute('data-theme') === 'dark' ? '#e5e7eb' : '#1e293b'
          },
          "studies_overrides": {
            "moving average.weighted.color": "#22c55e",
            "moving average.weighted.linewidth": 2
          }
        });

        this.startPriceUpdates();
      }

      toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        
        body.setAttribute('data-theme', newTheme);
        
        const themeBtn = this.elements.themeBtn;
        const icon = themeBtn.querySelector('.theme-icon');
        const text = themeBtn.querySelector('.theme-text');
        
        icon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        text.textContent = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
        
        const aiThemeBtn = this.aiElements.aiThemeBtn;
        const aiIcon = aiThemeBtn.querySelector('.theme-icon');
        const aiText = aiThemeBtn.querySelector('.theme-text');
        
        aiIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        aiText.textContent = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
        
        this.updateChartSymbol();
        
        localStorage.setItem('scalping-calculator-theme', newTheme);
      }

      updateChartSymbol() {
        const currency = this.currencies[this.currentCurrency];
        
        const chartContainer = document.getElementById('tradingview_chart');
        chartContainer.innerHTML = '';
        
        this.initChart();
      }

      changeTimeframe(timeframe) {
        this.currentTimeframe = timeframe;
        
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.timeframe === timeframe) {
            btn.classList.add('active');
          }
        });
        
        this.updateChartSymbol();
      }

      changeChartType(chartType) {
        this.currentChartType = chartType;
        
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.chartType === chartType) {
            btn.classList.add('active');
          }
        });
        
        this.updateChartSymbol();
      }

      startPriceUpdates() {
        setInterval(() => {
          if (this.lastPrice && Math.random() > 0.7) {
            const change = (Math.random() - 0.5) * 0.0005;
            const newPrice = this.lastPrice + change;
            this.updatePriceDisplay(newPrice);
          }
        }, 5000);
      }

      syncWithChart() {
        if (this.lastPrice) {
          this.elements.entry.value = this.lastPrice.toFixed(5);
          
          const currency = this.currencies[this.currentCurrency];
          const entry = parseFloat(this.elements.entry.value);
          const pipSize = currency.pipValue;
          
          const stopDistance = 10 * pipSize;
          this.elements.stop.value = (entry - stopDistance).toFixed(5);
          
          const takeDistance = 20 * pipSize;
          this.elements.take.value = (entry + takeDistance).toFixed(5);
          
          this.showStatus('‚úÖ Prices synced from chart!', 'success');
          this.calculate();
        } else {
          this.showStatus('Chart price not available yet. Please wait.', 'warning');
        }
      }

      setFromChart(field) {
        if (this.lastPrice) {
          const formattedPrice = this.currencies[this.currentCurrency].isGold ? 
            this.lastPrice.toFixed(2) : 
            this.lastPrice.toFixed(5);
          
          this.elements[field].value = formattedPrice;
          this.showStatus(`‚úÖ ${field.toUpperCase()} set from chart price`, 'success');
        } else {
          this.showStatus('Chart price not available yet.', 'warning');
        }
      }

      updateAllFromChart() {
        if (this.lastPrice) {
          const currency = this.currencies[this.currentCurrency];
          const entry = this.lastPrice;
          const pipSize = currency.pipValue;
          
          this.elements.entry.value = currency.isGold ? 
            entry.toFixed(2) : 
            entry.toFixed(5);
          
          const stopDistance = 10 * pipSize;
          this.elements.stop.value = currency.isGold ? 
            (entry - stopDistance).toFixed(2) : 
            (entry - stopDistance).toFixed(5);
          
          const takeDistance = 20 * pipSize;
          this.elements.take.value = currency.isGold ? 
            (entry + takeDistance).toFixed(2) : 
            (entry + takeDistance).toFixed(5);
          
          this.showStatus('‚úÖ All prices updated from chart!', 'success');
          this.calculate();
        }
      }

      analyzeTrade(pipsStop, rrRatio, riskPct, lots, currency) {
        let message = '';
        let type = 'success';

        const minPips = currency.isGold ? 50 : 3;
        const maxPips = currency.isGold ? 500 : 30;

        if (pipsStop < minPips) {
          message = `‚ö†Ô∏è Stop loss is very tight (under ${minPips} pips). ${currency.isGold ? 'Gold requires wider stops due to volatility.' : 'Consider spread impact.'}`;
          type = 'warning';
        } else if (pipsStop > maxPips) {
          message = `‚ö†Ô∏è Stop loss is wide (over ${maxPips} pips). This may not be scalping.`;
          type = 'warning';
        } else if (rrRatio < 1) {
          message = '‚ö†Ô∏è Risk:Reward is below 1:1. Consider adjusting your targets.';
          type = 'warning';
        } else if (rrRatio >= (currency.isGold ? 1.2 : 1.5)) {
          message = `‚úÖ Good risk:reward ratio for ${currency.symbol}!`;
          type = 'success';
        } else {
          message = `üìà Setup is acceptable for ${currency.symbol}.`;
          type = 'success';
        }

        if (riskPct > 2) {
          message += ' Risk percentage is high for scalping.';
          type = 'warning';
        }

        const maxLotsForCurrency = currency.isGold ? 20 : 50;
        if (lots > maxLotsForCurrency) {
          message += ` Position size is large for ${currency.symbol} - ensure sufficient margin.`;
          type = 'warning';
        }

        this.showStatus(message, type);
      }

      reset() {
        this.elements.entry.value = '';
        this.elements.stop.value = '';
        this.elements.take.value = '';
        this.elements.balance.value = '';
        this.elements.riskPct.value = '0.5';
        this.elements.pipValue.value = '10';

        this.resetResults();

        this.elements.entry.focus();
      }

      resetResults() {
        this.elements.result.classList.remove('show');
        this.hideStatus();
        
        this.elements.pipsStop.textContent = '‚Äî';
        this.elements.pipsTake.textContent = '‚Äî';
        this.elements.rr.textContent = '‚Äî';
        this.elements.riskUsd.textContent = '‚Äî';
        this.elements.lots.textContent = '‚Äî';
        this.elements.units.textContent = '‚Äî';
      }

      loadPreferences() {
        const savedTheme = localStorage.getItem('scalping-calculator-theme');
        if (savedTheme) {
          document.body.setAttribute('data-theme', savedTheme);
          const themeBtn = this.elements.themeBtn;
          const icon = themeBtn.querySelector('.theme-icon');
          const text = themeBtn.querySelector('.theme-text');
          
          icon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
          text.textContent = savedTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
        }

        const savedCurrency = localStorage.getItem('scalping-calculator-currency');
        if (savedCurrency && this.currencies[savedCurrency]) {
          this.selectCurrency(savedCurrency);
        }

        try {
          const saved = localStorage.getItem('scalping-calculator-inputs');
          if (saved) {
            const inputs = JSON.parse(saved);
            Object.keys(inputs).forEach(key => {
              if (this.elements[key]) {
                this.elements[key].value = inputs[key];
              }
            });
          }
        } catch (e) {
          console.log('No saved inputs found');
        }
      }

      savePreferences() {
        const inputs = {
          entry: this.elements.entry.value,
          stop: this.elements.stop.value,
          take: this.elements.take.value,
          balance: this.elements.balance.value,
          riskPct: this.elements.riskPct.value,
          pipValue: this.elements.pipValue.value
        };
        
        localStorage.setItem('scalping-calculator-inputs', JSON.stringify(inputs));
      }

      hideStatus() {
        this.elements.status.className = 'status';
      }
    }

    // Initialize the calculator when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.tradingApp = new FixedAlphaVantageTradingCalculator();
    });
  </script>
</body>
</html>
